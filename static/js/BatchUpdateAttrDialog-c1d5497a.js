var e=Object.defineProperty,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,o=(e,o)=>{for(var i in o||(o={}))t.call(o,i)&&s(e,i,o[i]);if(a)for(var i of a(o))l.call(o,i)&&s(e,i,o[i]);return e};import{W as i}from"./worker-25326b76.js";import{u as r,v as n}from"./editSpace-4c76f868.js";import{_ as c}from"./plugin-vue_export-helper-46f75680.js";import{d,r as p,t as g,c as m,w as f,g as u,a as h,o as b,b as $,f as y,j as L,h as C}from"./index-d8bc6699.js";const w=d({name:"BatchUpdateAttrDialog",components:{},props:{visible:{type:Boolean,default:!1}},emits:["close","reload"],setup(e,a){const{proxy:t}=u(),l=r();let s=p({loading:!1,isUpload:!1,dialogVisible:e.visible,fileList:[],fileListTemp:[],handleProgress:0,colors:[{color:"#f56c6c",percentage:20},{color:"#e6a23c",percentage:40},{color:"#5cb87a",percentage:60},{color:"#1989fa",percentage:80},{color:"#6f7ad3",percentage:100}],title:t.$t("message.upload"),button:t.$t("message.confirm")}),c={handleClose(){l.batchUpdateAttrData={},s.dialogVisible=!1,a.emit("close")},async handleConfirm(){n((async()=>{s.loading=!0;try{if(s.button===t.$t("message.download"))return s.title=t.$t("message.downloading"),l.exportData("players3",`players-${(new Date).getTime()}`,1),void setTimeout((()=>{c.handleClose()}),3e3);await c.handleCheck(),c.handleFileStream()}catch(e){c.handleError(e)}}),(()=>{t.$router.push("/price")}),"hasBatchUpdate")},handleFileStream(){s.isUpload=!0,s.title=t.$t("message.processing");let e=s.fileList,a=0,o={};for(let s=0;s<e.length;s++){let r=new FileReader;r.readAsText(e[s].raw),r.onload=function(n){let d=r.result.split("\r\n"),p=[];d.forEach((e=>{e&&p.push(e.split("\t"))}));const g=new i;g.postMessage({variables:p,type:1}),g.onmessage=i=>{a++;let r=e[s].name.split(".")[0];l.batchUpdateAttrData[r]=i.data,o[r]=i.data,a>=t.$config.supportPlayerFileList.length&&(g.terminate(),c.handleBatchUpdateAttr(o))}}}},handleBatchUpdateAttr(e){const a=new i;a.postMessage({variables:e,type:2}),a.onmessage=e=>{s.handleProgress=Number((100*e.data.status).toFixed(2)),s.handleProgress>=100&&(l.batchUpdateAttrData.players3=e.data.list,a.terminate(),s.loading=!1,s.title=t.$t("message.processed"),s.button=t.$t("message.download"))}},handleCheck:()=>new Promise(((e,a)=>{s.fileList.length<t.$config.supportPlayerFileList.length&&a(`${t.$t("message.uploadCheckFail_1")}`);let l=t.$config.supportPlayerFileList;s.fileList.forEach((e=>{l.includes(e.name)||a(`${t.$t("message.uploadCheckFail_2")}`)})),e(!0)})),handleChange(e,a){s.fileListTemp&&s.fileListTemp.length>0&&s.fileListTemp.forEach(((a,l)=>{a.name===e.name&&a.size===e.size&&(s.fileListTemp.splice(l,1),s.fileList.splice(l,1),t.$message.error(`${t.$t("message.uploadCheckFail_3")}`))})),s.fileListTemp=JSON.parse(JSON.stringify(s.fileList))},handleError(e){s.loading=!1,t.$message.error(`${t.$t("message.uploadCheckFail")} - `+e)},handleExceed(){t.$message.error(`${t.$t("message.uploadLimit")}`)}};return o(o({},g(s)),c)}}),_={class:"el-upload__text"},v={class:"el-upload__tip"},x={class:"dialog-footer"};var k=c(w,[["render",function(e,a,t,l,s,o){const i=h("upload-filled"),r=h("el-icon"),n=h("el-upload"),c=h("el-progress"),d=h("el-button"),p=h("el-dialog");return b(),m(p,{modelValue:e.dialogVisible,"onUpdate:modelValue":a[0]||(a[0]=a=>e.dialogVisible=a),title:e.title,"before-close":e.handleClose,class:"z-dialog",center:"",width:500},{footer:f((()=>[$("span",x,[y(d,{onClick:e.handleClose},{default:f((()=>[L(C(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),y(d,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:f((()=>[L(C(e.button),1)])),_:1},8,["onClick","loading"])])])),default:f((()=>[e.isUpload?(b(),m(c,{key:1,class:"flex-center",type:"circle",percentage:e.handleProgress,color:e.colors},null,8,["percentage","color"])):(b(),m(n,{key:0,ref:"uploadRef",class:"flex-column-center",drag:"",multiple:"",limit:e.$config.supportPlayerFileList.length,"auto-upload":!1,accept:".txt","on-exceed":e.handleExceed,"on-change":e.handleChange,"file-list":e.fileList},{tip:f((()=>[$("div",v,C(e.$t("message.desc"))+" "+C(e.$config.supportPlayerFileList.join("、"))+" "+C(e.$t("message.batchUpdateInfo")),1)])),default:f((()=>[y(r,{class:"el-icon--upload"},{default:f((()=>[y(i)])),_:1}),$("div",_,[L(C(e.$t("message.dragUpload"))+" ",1),$("em",null,C(e.$t("message.clickUpload")),1)])])),_:1},8,["limit","on-exceed","on-change","file-list"]))])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-18c206ac"]]);export{k as B};

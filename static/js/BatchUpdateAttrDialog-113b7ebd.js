var e=Object.defineProperty,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,o=(e,o)=>{for(var i in o||(o={}))t.call(o,i)&&s(e,i,o[i]);if(a)for(var i of a(o))l.call(o,i)&&s(e,i,o[i]);return e};import{u as i}from"./editSpace-760cb9b9.js";import{v as r}from"./util-440e36da.js";import{_ as n}from"./plugin-vue_export-helper-46f75680.js";import{d,r as c,t as p,c as g,w as m,g as f,a as u,o as h,b,f as $,j as y,h as L}from"./index-039ae85b.js";function C(){return new Worker("/assets/worker.e7a11fd7.js",{type:"module"})}const w=d({name:"BatchUpdateAttrDialog",components:{},props:{visible:{type:Boolean,default:!1}},emits:["close","reload"],setup(e,a){const{proxy:t}=f(),l=i();let s=c({loading:!1,isUpload:!1,dialogVisible:e.visible,fileList:[],fileListTemp:[],handleProgress:0,colors:[{color:"#f56c6c",percentage:20},{color:"#e6a23c",percentage:40},{color:"#5cb87a",percentage:60},{color:"#1989fa",percentage:80},{color:"#6f7ad3",percentage:100}],title:t.$t("message.upload"),button:t.$t("message.confirm")}),n={handleClose(){l.batchUpdateAttrData={},s.dialogVisible=!1,a.emit("close")},async handleConfirm(){r((async()=>{s.loading=!0;try{if(s.button===t.$t("message.download"))return s.title=t.$t("message.downloading"),l.exportData("players3",`players-${(new Date).getTime()}`,1),void setTimeout((()=>{n.handleClose()}),3e3);await n.handleCheck(),n.handleFileStream()}catch(e){n.handleError(e)}}))},handleFileStream(){s.isUpload=!0,s.title=t.$t("message.processing");let e=s.fileList,a=0,o={};for(let s=0;s<e.length;s++){let i=new FileReader;i.readAsText(e[s].raw),i.onload=function(r){let d=i.result.split("\r\n"),c=[];d.forEach((e=>{e&&c.push(e.split("\t"))}));const p=new C;p.postMessage({variables:c,type:1}),p.onmessage=i=>{a++;let r=e[s].name.split(".")[0];l.batchUpdateAttrData[r]=i.data,o[r]=i.data,a>=t.$config.supportPlayerFileList.length&&(p.terminate(),n.handleBatchUpdateAttr(o))}}}},handleBatchUpdateAttr(e){const a=new C;a.postMessage({variables:e,type:2}),a.onmessage=e=>{s.handleProgress=Number((100*e.data.status).toFixed(2)),s.handleProgress>=100&&(l.batchUpdateAttrData.players3=e.data.list,a.terminate(),s.loading=!1,s.title=t.$t("message.processed"),s.button=t.$t("message.download"))}},handleCheck:()=>new Promise(((e,a)=>{s.fileList.length<t.$config.supportPlayerFileList.length&&a(`${t.$t("message.uploadCheckFail_1")}`);let l=t.$config.supportPlayerFileList;s.fileList.forEach((e=>{l.includes(e.name)||a(`${t.$t("message.uploadCheckFail_2")}`)})),e(!0)})),handleChange(e,a){s.fileListTemp&&s.fileListTemp.length>0&&s.fileListTemp.forEach(((a,l)=>{a.name===e.name&&a.size===e.size&&(s.fileListTemp.splice(l,1),s.fileList.splice(l,1),t.$message.error(`${t.$t("message.uploadCheckFail_3")}`))})),s.fileListTemp=JSON.parse(JSON.stringify(s.fileList))},handleError(e){s.loading=!1,t.$message.error(`${t.$t("message.uploadCheckFail")} - `+e)},handleExceed(){t.$message.error(`${t.$t("message.uploadLimit")}`)}};return o(o({},p(s)),n)}}),_={class:"el-upload__text"},k={class:"el-upload__tip"},v={class:"dialog-footer"};var x=n(w,[["render",function(e,a,t,l,s,o){const i=u("upload-filled"),r=u("el-icon"),n=u("el-upload"),d=u("el-progress"),c=u("el-button"),p=u("el-dialog");return h(),g(p,{modelValue:e.dialogVisible,"onUpdate:modelValue":a[0]||(a[0]=a=>e.dialogVisible=a),title:e.title,"before-close":e.handleClose,"custom-class":"z-dialog",center:"",width:500},{footer:m((()=>[b("span",v,[$(c,{onClick:e.handleClose},{default:m((()=>[y(L(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),$(c,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:m((()=>[y(L(e.button),1)])),_:1},8,["onClick","loading"])])])),default:m((()=>[e.isUpload?(h(),g(d,{key:1,class:"flex-center",type:"circle",percentage:e.handleProgress,color:e.colors},null,8,["percentage","color"])):(h(),g(n,{key:0,ref:"uploadRef",class:"flex-column-center",drag:"",multiple:"",limit:e.$config.supportPlayerFileList.length,"auto-upload":!1,accept:".txt","on-exceed":e.handleExceed,"on-change":e.handleChange,"file-list":e.fileList},{tip:m((()=>[b("div",k,L(e.$t("message.desc"))+" "+L(e.$config.supportPlayerFileList.join("、"))+" "+L(e.$t("message.batchUpdateInfo")),1)])),default:m((()=>[$(r,{class:"el-icon--upload"},{default:m((()=>[$(i)])),_:1}),b("div",_,[y(L(e.$t("message.dragUpload"))+" ",1),b("em",null,L(e.$t("message.clickUpload")),1)])])),_:1},8,["limit","on-exceed","on-change","file-list"]))])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-79ea3e0a"]]);export{x as B,C as W};

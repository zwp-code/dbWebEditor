var e=Object.defineProperty,a=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(a,t,s)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,o=(e,o)=>{for(var l in o||(o={}))t.call(o,l)&&i(e,l,o[l]);if(a)for(var l of a(o))s.call(o,l)&&i(e,l,o[l]);return e};import{u as l,f as d}from"./editSpace-4390666c.js";import{W as n}from"./worker-25326b76.js";import{g as r,d as c,r as m,k as f,t as u,c as p,w as g,a as b,o as h,b as I,f as $,j as y,h as v,i as w}from"./index-34fbc855.js";import{_ as x}from"./plugin-vue_export-helper-46f75680.js";function _(){l();const{proxy:e}=r();return o({},{findDB:a=>new Promise(((t,s)=>{e.$zdb.then((e=>{e.query_by_cursor_index({tableName:"dbeditor",indexName:"id",indexValue:a,success:async e=>{if(!e.length)return s(new Error("打开项目失败"));t(e)}})}),(e=>{s(e)}))})),exportDB:a=>new Promise(((t,s)=>{e.$zdb.then((e=>{e.query_by_cursor_index({tableName:"dbeditor",indexName:"id",indexValue:a,success:async e=>{if(!e.length)return s(new Error("暂无数据可导出"));t(e)}})}),(e=>{s(e)}))})),clearDB:a=>new Promise(((t,s)=>{e.$zdb.then((e=>{e.delete_by_index({tableName:"dbeditor",indexName:"id",indexValue:a,success:()=>{t(!0)}})}),(e=>{s(e)}))})),updateDB:a=>new Promise(((t,s)=>{e.$zdb.then((e=>{e.update({tableName:"dbeditor",condition:e=>e.id===a.id,handle:e=>{e.data=a.data},success:e=>{t(!0)}})}),(e=>{s(e)}))})),saveDB:(a,t)=>new Promise(((s,i)=>{e.$zdb.then((e=>{e.insert({tableName:"dbeditor",data:{id:a,data:t},success:()=>{s(!0)}})}),(e=>{i(e)}))}))})}const V=c({name:"CacheItemDialog",components:{},props:{visible:{type:Boolean,default:!1},editInfo:{type:Object,default:null}},emits:["close","save"],setup(e,a){const t=l(),s=_();let{proxy:i}=r(),c=m({dialogVisible:e.visible,itemInfo:{name:"",desc:"",createAt:"",updateAt:"",id:t.projectUUID},progress:0,isloading:!1}),p={handleClose(){c.dialogVisible=!1,a.emit("close")},handleStorageProject(){let e=i.$utils.cache.cacheItems.get();if(e){let a=JSON.parse(e);if(a.find((e=>e.id===c.itemInfo.id)))for(let e=0;e<a.length;e++)a[e].id===c.itemInfo.id&&(a[e].name=c.itemInfo.name,a[e].desc=c.itemInfo.desc,a[e].updateAt=d());else c.itemInfo.createAt=d(),c.itemInfo.updateAt=d(),a.push(c.itemInfo);i.$utils.cache.cacheItems.set(JSON.stringify(a))}else{let e=[];c.itemInfo.createAt=d(),c.itemInfo.updateAt=d(),e.push(c.itemInfo),i.$utils.cache.cacheItems.set(JSON.stringify(e))}},handleConfirm(){i.$refs.form.validate((o=>{if(o){if(c.isloading=!0,e.editInfo)return p.handleStorageProject(),i.$message.success(i.$t("message.saveSucceeded")),c.isloading=!1,a.emit("save"),void p.handleClose();setTimeout((()=>{let e=t.formatDBToData();const a=new n;a.postMessage({variables:e,type:4}),a.onmessage=e=>{if(c.progress=Number((100*e.data.status).toFixed(2)),c.progress>=100){if(a.terminate(),JSON.parse(i.$utils.cache.cacheItems.get()||"[]").find((e=>e.id===c.itemInfo.id)))return void s.updateDB({id:c.itemInfo.id,data:e.data.list}).then((e=>{p.handleStorageProject(),i.$message.success(i.$t("message.saveSucceeded")),c.isloading=!1,p.handleClose()})).catch((e=>{i.$message.error(i.$t("message.saveFailed")),c.isloading=!1}));s.saveDB(c.itemInfo.id,e.data.list).then((e=>{p.handleStorageProject(),i.$message.success(i.$t("message.saveSucceeded")),c.isloading=!1,p.handleClose()})).catch((e=>{i.$message.error(i.$t("message.saveFailed")),c.isloading=!1}))}}}),60)}else i.$message.warning(i.$t("message.checkedFailed"))}))}};return f((()=>{e.editInfo&&(c.itemInfo.name=e.editInfo.name,c.itemInfo.desc=e.editInfo.desc,c.itemInfo.id=e.editInfo.id)})),o(o({},u(c)),p)}}),j={class:"dialog-footer"};var C=x(V,[["render",function(e,a,t,s,i,o){const l=b("el-input"),d=b("el-form-item"),n=b("el-progress"),r=b("el-form"),c=b("el-button"),m=b("el-dialog");return h(),p(m,{modelValue:e.dialogVisible,"onUpdate:modelValue":a[2]||(a[2]=a=>e.dialogVisible=a),title:e.$t("message.cacheItem"),width:500,"before-close":e.handleClose,class:"z-dialog",center:""},{footer:g((()=>[I("span",j,[$(c,{onClick:e.handleClose},{default:g((()=>[y(v(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),$(c,{type:"primary",onClick:e.handleConfirm,loading:e.isloading},{default:g((()=>[y(v(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])])),default:g((()=>[$(r,{ref:"form","label-position":"top","label-width":"100px","show-message":!1,model:e.itemInfo},{default:g((()=>[$(d,{label:e.$t("message.itemName"),required:"",prop:"name"},{default:g((()=>[$(l,{modelValue:e.itemInfo.name,"onUpdate:modelValue":a[0]||(a[0]=a=>e.itemInfo.name=a),clearable:""},null,8,["modelValue"])])),_:1},8,["label"]),$(d,{label:e.$t("message.itemDesc"),required:"",prop:"desc"},{default:g((()=>[$(l,{modelValue:e.itemInfo.desc,"onUpdate:modelValue":a[1]||(a[1]=a=>e.itemInfo.desc=a),clearable:""},null,8,["modelValue"])])),_:1},8,["label"]),e.editInfo?w("",!0):(h(),p(n,{key:0,percentage:e.progress,"text-inside":!0,"stroke-width":26,status:"success",striped:"","striped-flow":"",duration:10},null,8,["percentage"]))])),_:1},8,["model"])])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-3a9243d3"]]);export{C,_ as u};

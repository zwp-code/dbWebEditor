import{u as e}from"./editSpace-ebec7ddd.js";import{v as a}from"./util-b44001ea.js";import{_ as t}from"./plugin-vue_export-helper-46f75680.js";import{d as l,r as s,t as o,c as i,w as r,g as n,a as d,o as c,b as p,f as g,j as m,h as f}from"./index-7761de70.js";function u(){return new Worker("/assets/worker.e7a11fd7.js",{type:"module"})}const h=l({name:"BatchUpdateAttrDialog",components:{},props:{visible:{type:Boolean,default:!1}},emits:["close","reload"],setup(t,l){const{proxy:i}=n(),r=e();let d=s({loading:!1,isUpload:!1,dialogVisible:t.visible,fileList:[],fileListTemp:[],handleProgress:0,colors:[{color:"#f56c6c",percentage:20},{color:"#e6a23c",percentage:40},{color:"#5cb87a",percentage:60},{color:"#1989fa",percentage:80},{color:"#6f7ad3",percentage:100}],title:i.$t("message.upload"),button:i.$t("message.confirm")}),c={handleClose(){r.batchUpdateAttrData={},d.dialogVisible=!1,l.emit("close")},async handleConfirm(){a((async()=>{d.loading=!0;try{if(d.button===i.$t("message.download"))return d.title=i.$t("message.downloading"),r.exportData("players3",`players-${(new Date).getTime()}`,1),void setTimeout((()=>{c.handleClose()}),3e3);await c.handleCheck(),c.handleFileStream()}catch(e){c.handleError(e)}}))},handleFileStream(){d.isUpload=!0,d.title=i.$t("message.processing");let e=d.fileList,a=0,t={};for(let l=0;l<e.length;l++){let s=new FileReader;s.readAsText(e[l].raw),s.onload=function(o){let n=s.result.split("\r\n"),d=[];n.forEach((e=>{e&&d.push(e.split("\t"))}));const p=new u;p.postMessage({variables:d,type:1}),p.onmessage=s=>{a++;let o=e[l].name.split(".")[0];r.batchUpdateAttrData[o]=s.data,t[o]=s.data,a>=i.$config.supportPlayerFileList.length&&(p.terminate(),c.handleBatchUpdateAttr(t))}}}},handleBatchUpdateAttr(e){const a=new u;a.postMessage({variables:e,type:2}),a.onmessage=e=>{d.handleProgress=Number((100*e.data.status).toFixed(2)),d.handleProgress>=100&&(r.batchUpdateAttrData.players3=e.data.list,a.terminate(),d.loading=!1,d.title=i.$t("message.processed"),d.button=i.$t("message.download"))}},handleCheck:()=>new Promise(((e,a)=>{d.fileList.length<i.$config.supportPlayerFileList.length&&a(`${i.$t("message.uploadCheckFail_1")}`);let t=i.$config.supportPlayerFileList;d.fileList.forEach((e=>{t.includes(e.name)||a(`${i.$t("message.uploadCheckFail_2")}`)})),e(!0)})),handleChange(e,a){d.fileListTemp&&d.fileListTemp.length>0&&d.fileListTemp.forEach(((a,t)=>{a.name===e.name&&a.size===e.size&&(d.fileListTemp.splice(t,1),d.fileList.splice(t,1),i.$message.error(`${i.$t("message.uploadCheckFail_3")}`))})),d.fileListTemp=JSON.parse(JSON.stringify(d.fileList))},handleError(e){d.loading=!1,i.$message.error(`${i.$t("message.uploadCheckFail")} - `+e)},handleExceed(){i.$message.error(`${i.$t("message.uploadLimit")}`)}};return{...o(d),...c}}}),$={class:"el-upload__text"},b={class:"el-upload__tip"},y={class:"dialog-footer"};var L=t(h,[["render",function(e,a,t,l,s,o){const n=d("upload-filled"),u=d("el-icon"),h=d("el-upload"),L=d("el-progress"),C=d("el-button"),_=d("el-dialog");return c(),i(_,{modelValue:e.dialogVisible,"onUpdate:modelValue":a[0]||(a[0]=a=>e.dialogVisible=a),title:e.title,"before-close":e.handleClose,"custom-class":"z-dialog",center:"",width:500},{footer:r((()=>[p("span",y,[g(C,{onClick:e.handleClose},{default:r((()=>[m(f(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),g(C,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:r((()=>[m(f(e.button),1)])),_:1},8,["onClick","loading"])])])),default:r((()=>[e.isUpload?(c(),i(L,{key:1,class:"flex-center",type:"circle",percentage:e.handleProgress,color:e.colors},null,8,["percentage","color"])):(c(),i(h,{key:0,ref:"uploadRef",class:"flex-column-center",drag:"",multiple:"",limit:e.$config.supportPlayerFileList.length,"auto-upload":!1,accept:".txt","on-exceed":e.handleExceed,"on-change":e.handleChange,"file-list":e.fileList},{tip:r((()=>[p("div",b,f(e.$t("message.desc"))+" "+f(e.$config.supportPlayerFileList.join("、"))+" "+f(e.$t("message.batchUpdateInfo")),1)])),default:r((()=>[g(u,{class:"el-icon--upload"},{default:r((()=>[g(n)])),_:1}),p("div",$,[m(f(e.$t("message.dragUpload"))+" ",1),p("em",null,f(e.$t("message.clickUpload")),1)])])),_:1},8,["limit","on-exceed","on-change","file-list"]))])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-f7a21b8a"]]);export{L as B,u as W};
